cmake_minimum_required(VERSION 3.5)

set(PROJ "FlightController2")
project(${PROJ})

# All relative to project root, as generated by STM32CubeMX.
set(SOURCE_DIR ${CMAKE_SOURCE_DIR}/Src)
set(CMSIS_DIR ${CMAKE_SOURCE_DIR}/Drivers/CMSIS)
set(DEVICE_DIR ${CMAKE_SOURCE_DIR}/Drivers/CMSIS/Device/ST/STM32L4xx)
set(HAL_DIR ${CMAKE_SOURCE_DIR}/Drivers/STM32L4xx_HAL_Driver)

# Look here for header files.
include_directories(${CMAKE_SOURCE_DIR}/Inc)
include_directories(${CMSIS_DIR}/Include)
include_directories(${DEVICE_DIR}/Include)
include_directories(${HAL_DIR}/Inc)
include_directories(${RTOS_DIR}/include)
include_directories(${RTOS_DIR}/CMSIS_RTOS)
include_directories(${RTOS_DIR}/CMSIS_RTOS/include)
include_directories(${RTOS_DIR}/portable/GCC/ARM_CM4F)
include_directories(${USB_DIR}/Core/Inc)
include_directories(${USB_DIR}/Class/CDC/Inc)

# Some trickery to get CMake to deal with our assembler code.
set_property(SOURCE ${CMAKE_SOURCE_DIR}/startup/startup_stm32l432xx.s PROPERTY LANGUAGE C)

file(GLOB SOURCE_DIR_C ${SOURCE_DIR}/*.c)
file(GLOB HAL_DIR_C ${HAL_DIR}/Src/*.c)

# The linker flag --gc-section keeps unused object code here from being linked.
add_executable(DONOTUSE
        ${SOURCE_DIR_C}
        ${CMAKE_SOURCE_DIR}/startup_stm32l432xx.s
        ${HAL_DIR_C}
)


add_custom_target(
        BuildWithMake ALL
        COMMAND make
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/
)

